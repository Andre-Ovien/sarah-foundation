{% extends 'index.html' %}
{% load static %}

{% block body %}
  <!-- Page Title -->
  <div class="page-title dark-background" data-aos="fade"
       style="background-image: url('{% static "img/page-title-bg.jpg" %}');">
    <div class="container position-relative">
      <h1>Blog Details</h1>
      <p>Read the full article below.</p>
      <nav class="breadcrumbs">
        <ol>
          <li><a href="{% url 'home' %}">Home</a></li>
          <li><a href="/blog/">Blog</a></li>
          <li class="current">Detail</li>
        </ol>
      </nav>
    </div>
  </div>
  <!-- End Page Title -->

  <!-- Blog Detail Section -->
  <section id="blog" class="blog section">
    <div class="container" data-aos="fade-up">
      <div class="row g-5">
        <!-- Blog main content -->
        <div class="col-lg-8" id="blog-detail-container">
          <p>Loading blog post...</p>
        </div>
        <!-- Sidebar -->
        <div class="col-lg-4">
          <div class="sidebar">
            <h3 class="sidebar-title">Categories</h3>
            <div class="sidebar-item categories">
              <ul>
                <li><a href="#">Education</a></li>
                <li><a href="#">Foundation</a></li>
                <li><a href="#">News</a></li>
              </ul>
            </div>
          </div>
        </div>
        <!-- End Sidebar -->
      </div>
    </div>
  </section>

  <!-- Comments Section -->
  <section id="blog-comments" class="blog section">
    <div class="container" data-aos="fade-up">
      <div class="row g-5">
        <div class="col-lg-8">
          <div class="comments">
            <h4 class="comments-count"><b>Comments</b></h4>
            <div id="comments-container">
              <p>Loading comments...</p>
            </div>

            <!-- Comment Form -->
            <div class="reply-form mt-4">
              <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body">
                  <h5 class="card-title"><b>Leave a Comment</b></h5>
                  <p class="text-muted mb-4">Your email address will not be published. Required fields are marked *</p>
                  <form id="comment-form">
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <input type="text" id="comment-author" class="form-control"
                               placeholder="Your Name*" required>
                      </div>
                      <div class="col-md-6 mb-3">
                        <input type="email" id="comment-email" class="form-control"
                               placeholder="Your Email*" required>
                      </div>
                      <div class="col-12 mb-3">
                        <textarea id="comment-content" class="form-control"
                                  rows="4" placeholder="Your Comment*" required></textarea>
                      </div>
                      <div class="col-12 text-center">
                        <button type="submit" class="btn btn-success px-5">Post Comment</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <!-- End Comment Form -->

          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    document.addEventListener("DOMContentLoaded", function () {
      const pathParts = window.location.pathname.split("/");
      const postId = pathParts[pathParts.length - 2];

      // Fetch blog post
      fetch(`/blog/blog-detail/${postId}/`)
        .then(response => response.json())
        .then(post => {
          document.getElementById("blog-detail-container").innerHTML = `
            <article class="blog-details">
              <div class="post-img mb-3">
                <img src="${post.image}" alt="${post.title}" class="img-fluid rounded">
              </div>
              <h2 class="title">${post.title}</h2>
              <div class="meta-top mb-3">
                <ul>
                  <li><i class="bi bi-person"></i> ${post.author}</li>
                  <li><i class="bi bi-clock"></i> 
                    <time datetime="${post.publish_date}">
                      ${new Date(post.publish_date).toLocaleDateString()}
                    </time>
                  </li>
                </ul>
              </div>
              <div class="content">
                <p>${post.content}</p>
              </div>
            </article>
          `;

          // âœ… Load comments immediately after blog loads
          loadComments();
        });

      // Load comments
      function loadComments() {
        fetch(`/blog/blog/${postId}/comments/`)
          .then(response => response.json())
          .then(comments => {
            const container = document.getElementById("comments-container");
            container.innerHTML = "";

            if (!Array.isArray(comments) || comments.length === 0) {
              container.innerHTML = "<p>No comments yet. Be the first to comment!</p>";
              return;
            }

            comments.forEach(c => {
              container.innerHTML += `
                <div class="comment mb-3">
                  <h5><b>${c.name}<b></h5>
                  <p>${c.comment}</p>
                </div>
              `;
            });
          });
      }

      // Handle new comment
      document.getElementById("comment-form").addEventListener("submit", function (e) {
        e.preventDefault();
        const name = document.getElementById("comment-author").value;
        const email = document.getElementById("comment-email").value;
        const comment = document.getElementById("comment-content").value;

        fetch(`/blog/blog/${postId}/comments/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
          },
          body: JSON.stringify({ name, email, comment })
        })
          .then(response => {
            if (!response.ok) throw new Error("Failed to post comment");
            return response.json();
          })
          .then(() => {
            document.getElementById("comment-form").reset();
            loadComments();
          })
          .catch(err => console.error(err));
      });
    });
  </script>
{% endblock %}
